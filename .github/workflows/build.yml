name: Build DYYY

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

env:
  THEOS: ${{ github.workspace }}/theos
  SDK_URL: https://github.com/theos/sdks/releases/download/master-146e41f/iPhoneOS16.5.sdk.tar.xz

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Select Xcode 14.3
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '14.3.1'

      - name: Check Swift version
        run: xcrun swift -version

      - name: Install dependencies
        run: |
          brew update
          brew install ldid dpkg || true

      - name: Install theos and iOS 16.5 SDK
        run: |
          # 克隆 theos
          git clone --recursive https://github.com/theos/theos.git "$THEOS"

          # 下载并解压 iPhoneOS16.5.sdk 到 $THEOS/sdks
          mkdir -p "$THEOS/sdks"
          curl -L "$SDK_URL" -o /tmp/iPhoneOS16.5.sdk.tar.xz
          tar -xJf /tmp/iPhoneOS16.5.sdk.tar.xz -C "$THEOS/sdks"

          # 导出环境变量
          echo "THEOS=$THEOS" >> $GITHUB_ENV
          echo "PATH=$THEOS/bin:$PATH" >> $GITHUB_ENV

      - name: Build DYYY_2.3-1
        run: |
          cd DYYY_2.3-1
          make clean
          make package TARGET=iphone:clang:16.5:16.0

      - name: Build DYYY++
        run: |
          cd "DYYY++"
          make clean
          make package TARGET=iphone:clang:16.5:16.0

      - name: Upload .deb artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dyyy-debs
          path: |
            DYYY_2.3-1/packages/*.deb
            DYYY++/packages/*.deb
